(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6491],{81789:function(e,t,r){var i;"undefined"!=typeof self&&self,i=(e,t,r)=>(()=>{"use strict";var i,s,a,o,n,h,l,u,c,d,f,p,E,g,m,_,S,y=[,t=>{t.exports=e},e=>{e.exports=t},e=>{e.exports=r}],v={};function T(e){var t=v[e];if(void 0!==t)return t.exports;var r=v[e]={exports:{}};return y[e](r,r.exports,T),r.exports}T.d=(e,t)=>{for(var r in t)T.o(t,r)&&!T.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},T.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),T.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var b={};T.r(b),T.d(b,{MP3ToMP4Transmuxer:()=>em,PassThroughTransmuxer:()=>eh,Playlist:()=>B,PlaylistSegmentRetriever:()=>L,PlaylistType:()=>E,Segment:()=>en,TransmuxerFactory:()=>ey,buildNumber:()=>eI,events:()=>S,retrievalErrors:()=>_,version:()=>eA});var R=T(1),P=T(2);class A{getCode(){return"GENERIC"}}class I extends A{constructor(e){super(),this._code=e}getCode(){return"OGG_PARSER."+this._code}}function w(e,t){return!!(!e.mimeType||t.mimeType===e.mimeType)&&(!e.audioCodec||!!(t.audioCodec&&t.audioCodec.id===e.audioCodec.id))&&(!e.videoCodec||!!(t.videoCodec&&t.videoCodec.id===e.videoCodec.id))}class D extends A{constructor(e){super(),this._code=e}getCode(){return"MP3_TRANSMUXER."+this._code}}class N{constructor(e){this._msg=e}getMsg(){return this._msg}}class x extends N{constructor(){super("Was expecting the mp3 sync word or id3 tags, but got something else.")}}let M=R.helpers.find,k=R.eventDispatcher.EventDispatcher,F=R.helpers.abortableJob.abortedError,{prefixLogger:C,noOpLogger:O}=R.logger;(i=p||(p={}))[i.RETRIEVING_SEGMENT=0]="RETRIEVING_SEGMENT",i[i.RETRIEVED_SEGMENT=1]="RETRIEVED_SEGMENT",i[i.RETRIEVING_DATA=2]="RETRIEVING_DATA",i[i.COMPLETE=3]="COMPLETE";class L{constructor(e){this._onSegmentRequestQueued=new k,this._onSegmentRequestStart=new k,this._onSegmentRetrieved=new k,this._onSegmentRequestFailed=new k,this._onSegmentDataRetrieveStarted=new k,this._onSegmentReady=new k,this._onError=new k,this._segments=[],this._retrievingSegment=null,this._timerId=null,this._dead=!1;let{playlist:t,getPosition:r,maxBufferLength:i,cacheSize:s,transmuxer:a,logger:o=O}=e;if(this._logger=C(o,"PlaylistSegmentRetriever"),t&&!t.hasInitialUpdateCompleted())throw Error("Playlist retrieve has not completed.");if(i<0)throw Error("Max buffer length must be > 0.");if(s<0)throw Error("Cache size must be > 0.");this.onSegmentRequestQueued=this._onSegmentRequestQueued.getHandle(),this.onSegmentRequestStart=this._onSegmentRequestStart.getHandle(),this.onSegmentRetrieved=this._onSegmentRetrieved.getHandle(),this.onSegmentRequestFailed=this._onSegmentRequestFailed.getHandle(),this.onSegmentDataRetrieveStarted=this._onSegmentDataRetrieveStarted.getHandle(),this.onSegmentReady=this._onSegmentReady.getHandle(),this.onError=this._onError.getHandle(),this._playlist=t,this._transmuxer=a,this._getPosition=r,this._maxBufferLength=i,this._cacheSize=s,this._scheduleNextUpdate(0)}updateMaxBufferLength(e){if(this._ensureNotDead(),e<0)throw Error("Max buffer length must be > 0.");this._logger.debug("updateMaxBufferLength() called.",e),this._maxBufferLength=e,this.update()}updateCacheSize(e){if(this._ensureNotDead(),e<0)throw Error("Cache size must be > 0.");this._cacheSize=e,this.update()}getCacheSize(){return this._cacheSize}getCacheUsage(){return this._segments.reduce((e,t)=>t.state===p.RETRIEVING_DATA||t.state===p.COMPLETE?e+t.size:e,0)}switchPlaylist(e){if(this._ensureNotDead(),e&&!e.hasInitialUpdateCompleted())throw Error("Playlist retrieve has not completed.");this._logger.debug("switchPlaylist() called."),this._abortCurrentRetrieve(),this._playlist=e,this._segments=this._segments.filter(e=>e.state===p.COMPLETE),this.update()}getSegmentsWithData(){return this._ensureNotDead(),this._segments.filter(e=>e.state===p.RETRIEVING_DATA&&e.size||e.state===p.COMPLETE).map(e=>{let{segment:t,dataRetrieveJob:r}=e;return{segment:t,dataRetrieveJob:r,complete:e.state===p.COMPLETE}})}update(){this._ensureNotDead(),this._timerId&&(window.clearTimeout(this._timerId),this._timerId=null);let e=this._getPosition(),t=e,r=0;this._segments.some(i=>{if(i.state!==p.COMPLETE)return!1;let s=i.segment.getTimeRange();return s.containsTime(r)&&(r=s.end),!(s.end<e)&&(s.start>t||(t=s.end,!1))});let i=e+this._maxBufferLength;if(!(()=>{let e=this._playlist;return e&&e.hasEnded()&&t===e.getDuration()?(t=r,e.getDuration()+r<i):t<i})()){this._abortCurrentRetrieve(),this._garbageCollect(e),this._scheduleNextUpdate();return}let s=M(this._segments,e=>(e.state===p.RETRIEVED_SEGMENT||e.state===p.RETRIEVING_DATA)&&e.segment.getTimeRange().containsTime(t));s?this._retrieveSegmentData(s):this._retrieveSegment(t),this._garbageCollect(e)}kill(){this._dead||(this._logger.debug("kill() called."),this._abortCurrentRetrieve(),this._dead=!0,this._timerId&&(this._logger.debug("Cancelling update timer."),window.clearTimeout(this._timerId)),this._segments=[],this._logger.debug("Killed."))}_retrieveSegmentData(e){if(e.state!==p.RETRIEVED_SEGMENT&&e.state!==p.RETRIEVING_DATA)throw Error("Segment in incorrect state for data to be retrieved.");if(this._retrievingSegment&&this._retrievingSegment.state===p.RETRIEVING_DATA&&e.segment===this._retrievingSegment.segment)return;this._abortCurrentRetrieve();let t=R.helpers.abortableJob.map(()=>this._transmuxer.transmux(e.segment.retrieveData()),{convertResult:e=>e,convertProgressUpdate:e=>e,abortableJobOpts:{storeResult:!0}}),r=t.run(),i=!1,s=this._retrievingSegment={state:p.RETRIEVING_DATA,dataRetrieveJob:t,dataRetrieveJobHandle:r,segment:e.segment,size:0};this._switchSegment(e,s),r.onProgressUpdate(r=>{let a=s.size,o=a;!i&&r.initData&&(a+=r.initData.byteLength),i=!0,a+=r.data.byteLength,s.size=a,0===o&&a>0&&this._onSegmentDataRetrieveStarted.dispatch({segment:e.segment,dataRetrieveJob:t,complete:!1})}),r.onCompletion(()=>{if(this._retrievingSegment=null,s.state!==p.RETRIEVING_DATA)throw Error("Incorrect retrieval state.");this._switchSegment(s,{state:p.COMPLETE,dataRetrieveJob:s.dataRetrieveJob,dataRetrieveJobHandle:s.dataRetrieveJobHandle,segment:e.segment,size:s.size}),this._logger.debug("Segment retrieve completed.",e.segment.getEventRepresentation()),this.update(),this._onSegmentReady.dispatch({segment:e.segment,complete:!0,dataRetrieveJob:s.dataRetrieveJob})}),r.onError(t=>{t!==F&&(this._logger.error("Error retrieving segment data.",t,e.segment.getEventRepresentation()),this._scheduleNextUpdate(),t instanceof P.OggParserError?t=new I(t instanceof P.ChecksumFailedError?"CHECKSUM_FAILED":t instanceof P.NoSegmentsInPageError?"NO_SEGMENTS_IN_PAGE":t instanceof P.PageFromDifferentBitstreamError?"PAGE_FROM_DIFFERENT_BITSTREAM":t instanceof P.PageSequenceNumberDidNotIncrementError?"SEQUENCE_NUMBER_DID_NOT_INCREMENT":t instanceof P.UnexpectedBOSError?"UNEXPECTED_BOS":t instanceof P.UnexpectedEOSError?"UNEXPECTED_EOS":"UNKNOWN"):t instanceof N&&(t=new D(t instanceof x?"NOISE":"UNKNOWN")),this._onError.dispatch(t))})}_retrieveSegment(e){let t=this._retrievingSegment,r=this._playlist,i=r?r.getSegmentIndexContainingTime(e):null;if(!t||t.state!==p.RETRIEVING_SEGMENT||t.segmentIndex!==i){if(this._abortCurrentRetrieve(),r){if(null===i)this._scheduleNextUpdate();else{let e=r.getSegment(i);this._logger.debug("Retrieving segment.",i),e.onCompletion(e=>{if(this._logger.debug("Retrieved segment.",i),!w(this._transmuxer.getInputFormat(),e.getFormat())){let e=Error("Segment format is not supported by transmuxer.");this._logger.error("Segment incorrect format.",e),this._scheduleNextUpdate(),this._onError.dispatch(e);return}e.onSegmentRequestQueued.subscribe(this._onSegmentRequestQueued.dispatch),e.onSegmentRequestStart.subscribe(this._onSegmentRequestStart.dispatch),e.onSegmentRetrieved.subscribe(this._onSegmentRetrieved.dispatch),e.onSegmentRequestFailed.subscribe(this._onSegmentRequestFailed.dispatch),this._segments.splice(this._segments.indexOf(t),1);let r=e.getTimeRange(),s=this._segments.length;this._segments.some((e,t)=>e.state!==p.RETRIEVING_SEGMENT&&e.segment.getTimeRange().start>r.start&&(s=t,!0)),this._segments.splice(s,0,{state:p.RETRIEVED_SEGMENT,segment:e}),this._retrievingSegment=null,this.update()}),e.onError(e=>{e!==F&&(this._logger.error("Error retrieving segment.",e),this._scheduleNextUpdate(),this._onError.dispatch(e))});let t={state:p.RETRIEVING_SEGMENT,segmentIndex:i,segmentRetrieveJob:e};this._segments.push(t),this._retrievingSegment=t}}else this._logger.debug("Cannot retrieve segment as there is no playlist."),this._scheduleNextUpdate()}}_abortCurrentRetrieve(){let e=this._retrievingSegment;e&&(e.state===p.RETRIEVING_SEGMENT?(this._logger.debug("Aborting segment retrieve job."),e.segmentRetrieveJob.abort()):e.state===p.RETRIEVING_DATA&&(this._logger.debug("Aborting segment data retrieve job."),e.dataRetrieveJobHandle.abort(),this._switchSegment(e,{state:p.RETRIEVED_SEGMENT,segment:e.segment})),this._retrievingSegment=null)}_switchSegment(e,t){let r=this._segments.indexOf(e);if(-1===r)throw Error("Old segment missing.");this._segments.splice(r,1,t)}_garbageCollect(e){let t=this._segments,r=this._cacheSize,i=this.getCacheUsage();if(i<=r)return;let s=this._playlist,a=s&&s.getCompleteDuration(),o=null!==a?a:1/0,n=e+this._maxBufferLength;n>o&&(n-=o)>=e||t.filter(t=>t.state===p.COMPLETE&&!function(e,t,r){let i=e.getTimeRange();return r!==t&&(r>t?i.end>t&&i.start<r:i.end>t||i.start<r)}(t.segment,e,n)).map(t=>{let r=t.segment.getTimeRange().start;return{segment:t,distance:Math.min(Math.abs(e-r),r+o-e),size:t.size}}).sort((e,t)=>t.distance-e.distance).some(e=>i<=r||(t.splice(t.indexOf(e.segment),1),i-=e.size,!1))}_scheduleNextUpdate(e=1e3){this._timerId||(this._timerId=window.setTimeout(()=>{this._timerId=null,this.update()},e))}_ensureNotDead(){if(this._dead)throw Error("Playlist segment retriever has been killed.")}}let U=R.eventDispatcher.EventDispatcher;(s=E||(E={}))[s.LIVE=0]="LIVE",s[s.EVENT=1]="EVENT",s[s.VOD=2]="VOD";class B{constructor(){this._onPlaylistRequestQueued=new U,this._onPlaylistRequestStart=new U,this._onPlaylistRetrieved=new U,this._onPlaylistRequestFailed=new U,this._onPlaylistParseStart=new U,this._onPlaylistParseEnd=new U,this._onKeyRequestQueued=new U,this._onKeyRequestStart=new U,this._onKeyRetrieved=new U,this._onKeyRequestFailed=new U,this._onInitDataRequestQueued=new U,this._onInitDataRequestStart=new U,this._onInitDataRetrieved=new U,this._onInitDataRequestFailed=new U,this._onUpdated=new U,this.onPlaylistRequestQueued=this._onPlaylistRequestQueued.getHandle(),this.onPlaylistRequestStart=this._onPlaylistRequestStart.getHandle(),this.onPlaylistRetrieved=this._onPlaylistRetrieved.getHandle(),this.onPlaylistRequestFailed=this._onPlaylistRequestFailed.getHandle(),this.onPlaylistParseStart=this._onPlaylistParseStart.getHandle(),this.onPlaylistParseEnd=this._onPlaylistParseEnd.getHandle(),this.onKeyRequestQueued=this._onKeyRequestQueued.getHandle(),this.onKeyRequestStart=this._onKeyRequestStart.getHandle(),this.onKeyRetrieved=this._onKeyRetrieved.getHandle(),this.onKeyRequestFailed=this._onKeyRequestFailed.getHandle(),this.onInitDataRequestQueued=this._onInitDataRequestQueued.getHandle(),this.onInitDataRequestStart=this._onInitDataRequestStart.getHandle(),this.onInitDataRetrieved=this._onInitDataRetrieved.getHandle(),this.onInitDataRequestFailed=this._onInitDataRequestFailed.getHandle(),this.onUpdated=this._onUpdated.getHandle()}update(){let e=this._update();return e.onCompletion(()=>this._onUpdated.dispatch(void 0)),e}getSegment(e){return this.getSegments(e,e+1)[0]}getSegments(e,t){let r=this.getSegmentCount(),i=this.getFirstSegmentIndex();if(void 0===t&&(t=i+r),void 0===e&&(e=i),e<i||t<e||t>i+r)throw Error("Invalid range of segments.");let s=[];for(let r=e;r<t;r++)s.push(this._getSegment(r));return s}}class z{constructor(e,t,r){this._playlist=e,this._url=t,this._sequenceNumber=r}getPlaylist(){return this._playlist}getUrl(){return this._url}getSequenceNumber(){return this._sequenceNumber}}let G=R.helpers.abortableJob.AbortableJob,H=R.helpers.arrayBuffer.combine,q=new R.helpers.SCWeakMap;class V{constructor(e,t){this.retrievePages=e,this.retrievePackets=t}getFormat(){return{mimeType:"audio/ogg",audioCodec:{id:"opus"}}}parseSegmentData(e,t,r){return new G(()=>{let i=R.helpers.deferred.buildDeferred(),s=new R.eventDispatcher.EventDispatcher,a=[],o=null,n=null,h=null,l=t=>{i.reject(t),e.abort()},u=e=>{q.set(r,e),s.dispatch({initData:e,data:H(a)})};return e.onProgressUpdate(e=>{if(o&&"PRESENT"===o.state&&o.initDataEnded)a.push(e),s.dispatch({initData:o.initData,data:e});else if(o&&"NOT_PRESENT"===o.state)a.push(e);else{a.push(e);let i=H(a);if(o=this.tryExtractInitData(i)){if("NOT_PRESENT"===o.state){let e=q.get(r);t.getSequenceNumber()<=r.getFirstSegmentIndex()?l(Error("Could not find init data.")):e?u((o={state:"PRESENT",initData:e,initDataEnded:!0}).initData):((n=r.getSegment(r.getFirstSegmentIndex())).onCompletion(e=>{let t=h=this.parseSegmentData(R.helpers.abortableJob.map(()=>e.retrieveData(),{convertProgressUpdate:e=>e.initData?R.helpers.arrayBuffer.combine([e.initData,e.data]):e.data,convertResult:e=>e}).run(),e,r);t.onProgressUpdate(({initData:e})=>{if(t.abort(),!e){let e=Error("OggOpusSegmentParser should always provide init data.");throw l(e),e}o={state:"PRESENT",initData:e,initDataEnded:!0},u(e)}),t.onError(e=>{e!==R.helpers.abortableJob.abortedError&&l(e)})}),n.onError(l))}else if("PRESENT"===o.state&&o.initDataEnded){if(a.splice(0),i.byteLength>o.initData.byteLength){let e=new Uint8Array(i.buffer.slice(o.initData.byteLength));a.push(e)}u(o.initData)}}}}),e.onCompletion(e=>{o&&"PRESENT"===o.state&&!o.initDataEnded?(u(o.initData),i.resolve(e)):o&&"PRESENT"===o.state?i.resolve(e):i.reject(Error("Could not find init data."))}),e.onError(l),{result:i.promise,progressUpdates:{onProgressUpdate:s,getProgressSoFar:()=>o&&"PRESENT"===o.state&&o.initDataEnded?{initData:o.initData,data:H(a)}:null},abort:()=>{e.abort(),n&&n.abort(),h&&h.abort()}}}).run()}tryExtractInitData(e){let{pages:t}=this.retrievePages(e);if(t.length){let[e]=this.retrievePackets([t[0]]);if(!e||!e.first)return{state:"NOT_PRESENT"};{let e=1,r=t.slice(1).some((t,r)=>{let i=!!(1&t.header.type[0]);return r>0&&!i||(e=r+2,!1)});return{state:"PRESENT",initData:H(t.slice(0,e).map(e=>e.entirePage)),initDataEnded:r}}}return null}}let K=[new V(P.retrievePages,P.retrievePackets),{getFormat:()=>({}),parseSegmentData:e=>R.helpers.abortableJob.map(()=>e,{convertProgressUpdate:e=>({data:e}),convertResult:e=>e}).run()}],J=R.helpers.find,j={retrieveSegmentParser(e){let t=J(K,t=>w(t.getFormat(),e));if(!t)throw Error("No segment parser found.");return t}};class Q extends A{constructor(e){super(),this._statusCode=e}getStatusCode(){return this._statusCode}getCode(){return"UNACCEPTABLE_RESPONSE_STATUS_CODE"}}function W(e){return(W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Y(e){var t=e.byteLength,r=new DataView(e),i=t&&r.getUint8(t-1);if(!i)return e;for(var s=t-i,a=new Uint8Array(s),o=0;o<s;o++)a[o]=r.getUint8(o);return a.buffer}var Z=(a=function e(){(function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")})(this,e),this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()},o=[{key:"uint8ArrayToUint32Array_",value:function(e){for(var t=new DataView(e),r=new Uint32Array(4),i=0;i<4;i++)r[i]=t.getUint32(4*i);return r}},{key:"initTable",value:function(){var e=this.sBox,t=this.invSBox,r=this.subMix,i=r[0],s=r[1],a=r[2],o=r[3],n=this.invSubMix,h=n[0],l=n[1],u=n[2],c=n[3],d=new Uint32Array(256),f=0,p=0,E=0;for(E=0;E<256;E++)E<128?d[E]=E<<1:d[E]=E<<1^283;for(E=0;E<256;E++){var g=p^p<<1^p<<2^p<<3^p<<4;g=g>>>8^255&g^99,e[f]=g,t[g]=f;var m=d[f],_=d[m],S=d[_],y=257*d[g]^16843008*g;i[f]=y<<24|y>>>8,s[f]=y<<16|y>>>16,a[f]=y<<8|y>>>24,o[f]=y,y=16843009*S^65537*_^257*m^16843008*f,h[g]=y<<24|y>>>8,l[g]=y<<16|y>>>16,u[g]=y<<8|y>>>24,c[g]=y,f?(f=m^d[d[d[S^m]]],p^=d[d[p]]):f=p=1}}},{key:"expandKey",value:function(e){for(var t,r,i,s,a=this.uint8ArrayToUint32Array_(e),o=!0,n=0;n<a.length&&o;)o=a[n]===this.key[n],n++;if(!o){this.key=a;var h=this.keySize=a.length;if(4!==h&&6!==h&&8!==h)throw Error("Invalid aes key size="+h);var l=this.ksRows=(h+6+1)*4,u=this.keySchedule=new Uint32Array(l),c=this.invKeySchedule=new Uint32Array(l),d=this.sBox,f=this.rcon,p=this.invSubMix,E=p[0],g=p[1],m=p[2],_=p[3];for(t=0;t<l;t++){if(t<h){i=u[t]=a[t];continue}s=i,t%h==0?s=(d[(s=s<<8|s>>>24)>>>24]<<24|d[s>>>16&255]<<16|d[s>>>8&255]<<8|d[255&s])^f[t/h|0]<<24:h>6&&t%h==4&&(s=d[s>>>24]<<24|d[s>>>16&255]<<16|d[s>>>8&255]<<8|d[255&s]),u[t]=i=(u[t-h]^s)>>>0}for(r=0;r<l;r++)t=l-r,s=3&r?u[t]:u[t-4],r<4||t<=4?c[r]=s:c[r]=E[d[s>>>24]]^g[d[s>>>16&255]]^m[d[s>>>8&255]]^_[d[255&s]],c[r]=c[r]>>>0}}},{key:"networkToHostOrderSwap",value:function(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}},{key:"decrypt",value:function(e,t,r,i){for(var s,a,o,n,h,l,u,c,d,f,p,E,g,m,_=this.keySize+6,S=this.invKeySchedule,y=this.invSBox,v=this.invSubMix,T=v[0],b=v[1],R=v[2],P=v[3],A=this.uint8ArrayToUint32Array_(r),I=A[0],w=A[1],D=A[2],N=A[3],x=new Int32Array(e),M=new Int32Array(x.length),k=this.networkToHostOrderSwap;t<x.length;){for(m=1,d=k(x[t]),f=k(x[t+1]),p=k(x[t+2]),E=k(x[t+3]),h=d^S[0],l=E^S[1],u=p^S[2],c=f^S[3],g=4;m<_;m++)s=T[h>>>24]^b[l>>16&255]^R[u>>8&255]^P[255&c]^S[g],a=T[l>>>24]^b[u>>16&255]^R[c>>8&255]^P[255&h]^S[g+1],o=T[u>>>24]^b[c>>16&255]^R[h>>8&255]^P[255&l]^S[g+2],n=T[c>>>24]^b[h>>16&255]^R[l>>8&255]^P[255&u]^S[g+3],h=s,l=a,u=o,c=n,g+=4;s=y[h>>>24]<<24^y[l>>16&255]<<16^y[u>>8&255]<<8^y[255&c]^S[g],a=y[l>>>24]<<24^y[u>>16&255]<<16^y[c>>8&255]<<8^y[255&h]^S[g+1],o=y[u>>>24]<<24^y[c>>16&255]<<16^y[h>>8&255]<<8^y[255&l]^S[g+2],n=y[c>>>24]<<24^y[h>>16&255]<<16^y[l>>8&255]<<8^y[255&u]^S[g+3],g+=3,M[t]=k(s^I),M[t+1]=k(n^w),M[t+2]=k(o^D),M[t+3]=k(a^N),I=d,w=f,D=p,N=E,t+=4}return i?Y(M.buffer):M.buffer}},{key:"destroy",value:function(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}],function(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){var t=function(e,t){if("object"!=W(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=W(i))return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==W(t)?t:t+""}(i.key),i)}}(a.prototype,o),Object.defineProperty(a,"prototype",{writable:!1}),a);let X=null,$=[{canDecrypt:e=>"AES-CBC"===e.cipher,decrypt(e,t){X||(X=new Z);let r=X;return new R.helpers.abortableJob.AbortableJob(()=>{let i;let s=new R.eventDispatcher.EventDispatcher,a=R.helpers.deferred.buildDeferred(),o=[],n=null,h=[],l=0,u=new Uint8Array(t.iv),c=!1;r.expandKey(t.key.buffer);let d=e=>{let t=n;n=new Uint8Array(r.decrypt(e.buffer,0,u.buffer,!1));let i=e.byteLength-16;if(i<0)throw Error("lastBlockOffset invalid.");for(let t=0;t<16;t++)u[t]=e[i+t];t&&(o.push(t),s.dispatch(t))};return e.onProgressUpdate(e=>{!c&&(R.helpers.arrayBuffer.forEach(e,e=>{c||(l||(i=new Uint8Array(16)),i[l++]=e,16!==l||(h.push(i),l=0))}),h.length&&(d(R.helpers.arrayBuffer.combine(h)),h=[]))}),e.onCompletion(e=>{if(!c){if(l)a.reject(Error("Reached end part way through block."));else{if(n){let e=new Uint8Array(Y(n.buffer));o.push(e),s.dispatch(e)}a.resolve(e)}}}),e.onError(a.reject),{result:a.promise,abort:()=>{c=!0,e.abort()},progressUpdates:{onProgressUpdate:s,getProgressSoFar:()=>R.helpers.arrayBuffer.combine(o)}}}).run()}}],ee=R.helpers.find,et={retrieveDecryptor:e=>ee($,t=>t.canDecrypt(e))||null};class er extends A{getCode(){return"NO_DECRYPTOR"}}function ei({encryptionConfig:e,downloadAbortableJob:t,logger:r,decryptorFactory:i=et}){return new R.helpers.abortableJob.AbortableJob(()=>{let s=new R.eventDispatcher.EventDispatcher,a=R.helpers.deferred.buildDeferred(),o=null;if(e&&(r.info("Finding a decryptor..."),!(o=i.retrieveDecryptor(e))))return r.error("Could not find a decryptor."),a.reject(new er),{result:a.promise,progressUpdates:{onProgressUpdate:s,getProgressSoFar:()=>null}};let n=t.run(),h=null,l=[];return e&&o?((h=o.decrypt(n,e)).onProgressUpdate(e=>{l.push(e),s.dispatch(e)}),h.onError(e=>{e!==R.helpers.abortableJob.abortedError&&r.error("Error occurred during decryption.",e),a.reject(e),n.abort()})):n.onProgressUpdate(e=>{l.push(e),s.dispatch(e)}),n.onCompletion(()=>{let e=()=>a.resolve(void 0);h?h.whenComplete().then(()=>e()):e()}),n.onError(a.reject),{result:a.promise,progressUpdates:{onProgressUpdate:s,getProgressSoFar:()=>l.length?R.helpers.arrayBuffer.combine(l):null},abort:()=>{n.abort(),h&&h.abort()}}})}let es=R.helpers.abortableJob.AbortableJob,ea=R.eventDispatcher.EventDispatcher,{noOpLogger:eo}=R.logger;class en{constructor({url:e,sequenceNumber:t,playlist:r,timeRange:i,encryptionConfig:s,initData:a,format:o,loader:n,playlistEventRepresentation:h,logger:l=eo,delayCalculator:u=R.helpers.retry.buildExponentialDelayCalculator(),isResponseCodeAcceptable:c=e=>200===e,isResponseCodeRetryable:d=e=>!(e>=400&&e<500),getSegmentDownloadAndDecryptJob:f=ei}){this._onSegmentRequestQueued=new ea,this._onSegmentRequestStart=new ea,this._onSegmentRetrieved=new ea,this._onSegmentRequestFailed=new ea,this.onSegmentRequestQueued=this._onSegmentRequestQueued.getHandle(),this.onSegmentRequestStart=this._onSegmentRequestStart.getHandle(),this.onSegmentRetrieved=this._onSegmentRetrieved.getHandle(),this.onSegmentRequestFailed=this._onSegmentRequestFailed.getHandle(),this._sequenceNumber=t,this._playlist=r,this._timeRange=i,this._format=o;let p=f({encryptionConfig:s,downloadAbortableJob:function({delayCalculator:e,segmentEventRepresentation:t,url:r,loader:i,onSegmentRequestQueued:s,onSegmentRequestStart:a,onSegmentRequestFailed:o,onSegmentRetrieved:n,isResponseCodeAcceptable:h,isResponseCodeRetryable:l,logger:u}){return new R.helpers.abortableJob.AbortableJob(()=>{let c=R.helpers.deferred.buildDeferred(),d=new R.eventDispatcher.EventDispatcher,f=[],p=0,{cancel:E}=R.helpers.retry.retry(e,({scheduleRetry:e})=>{let E=!1,g=0;s.dispatch({segment:t}),u.debug("Requesting segment.",r);let m=i.request({url:r});m.onRequestStart(()=>a.dispatch({segment:t}));let _=e=>{let t=e.byteLength;if(t){if((g+=t)<=p)u.debug("Already downloaded this part. Skipping...",g,p);else{let r=new Uint8Array(e,t-(g-p));p=g,f.push(r),d.dispatch(r)}}};return m.onProgress(({initial:i,statusCode:s,part:a})=>{if(i){if(h(s))u.debug("Segment response started.",r,s),_(a);else{let i=null;l(s)?u.debug("Segment response code was not acceptable. Will retry.",r,s):(u.debug("Segment response code was not acceptable.",r,s),i=new Q(s)),m.abort(),o.dispatch({segment:t,statusCode:s}),i?c.reject(i):(E=!0,e())}}else u.debug("Got segment response part.",r,s),_(a)}),m.onResponseReceived(i=>{E||(i?(n.dispatch({segment:t,statusCode:i.statusCode}),c.resolve(void 0)):(u.warn("Segment request timed out.",r),o.dispatch({segment:t,statusCode:null}),e()))}),m.onError(t=>{E||t===R.helpers.abortableJob.abortedError||(t instanceof R.loaderErrors.LoaderError?(u.warn("Error from loader. Will retry",r,t),e()):(u.error("Unexpected error when requesting segment.",t),c.reject(t)))}),{onCancel:()=>{u.debug("Aborting segment request.",r),m.hasCompleted()||m.abort(),o.dispatch({segment:t,aborted:!0})}}},{onNoMoreRetries:()=>c.reject(Error("No more retries for requesting segment."))});return{result:c.promise,progressUpdates:{onProgressUpdate:d,getProgressSoFar:()=>f.length?R.helpers.arrayBuffer.combine(f):null},abort:()=>E()}})}({delayCalculator:u,segmentEventRepresentation:this._segmentEventRepresentation=new z(h,e,t),url:e,loader:n,onSegmentRequestQueued:this._onSegmentRequestQueued,onSegmentRequestStart:this._onSegmentRequestStart,onSegmentRequestFailed:this._onSegmentRequestFailed,onSegmentRetrieved:this._onSegmentRetrieved,isResponseCodeAcceptable:c,isResponseCodeRetryable:d,logger:l}),logger:l});this._retrieveAbortableJob=new es(()=>{let e=j.retrieveSegmentParser(this._format),t=new ea,r=R.helpers.deferred.buildDeferred(),i=e.parseSegmentData(R.helpers.abortableJob.map(()=>p.run(),{convertProgressUpdate:(e,t)=>t&&a?R.helpers.arrayBuffer.combine([a,e]):e,convertResult:e=>e}).run(),this,this._playlist);return i.onProgressUpdate(t.dispatch,{skipPast:!0}),i.onCompletion(()=>r.resolve(void 0)),i.onError(r.reject),{result:r.promise,progressUpdates:{onProgressUpdate:t,getProgressSoFar:i.getProgressSoFar},abort:i.abort}})}getFormat(){return this._format}getSequenceNumber(){return this._sequenceNumber}isFinalSegment(){let e=this._playlist;return e.hasEnded()&&e.getFirstSegmentIndex()+e.getSegmentCount()-1===this._sequenceNumber}getTimeRange(){return this._timeRange}getEventRepresentation(){return this._segmentEventRepresentation}retrieveData(){return new es(()=>{let e;let t=R.helpers.deferred.buildDeferred(),r=new ea,i=[],s=this._retrieveAbortableJob.run();return s.onProgressUpdate(({data:t,initData:s})=>{i.length||(e=s),i.push(t),r.dispatch({data:t,initData:e})}),s.onCompletion(()=>{t.resolve(void 0)}),s.onError(t.reject),{result:t.promise,progressUpdates:{onProgressUpdate:r,getProgressSoFar:()=>i.length?{initData:e,data:R.helpers.arrayBuffer.combine(i)}:null},abort:()=>s.abort()}}).run()}}let eh={getInputFormat:()=>({}),getOutputFormat:()=>({}),transmux:e=>e};var el=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],eu=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3];function ec(){this.buffer=null,this.bufferSize=0}function ed(e){return e.byteLength>=3&&73===e[0]&&68===e[1]&&51===e[2]}ec.prototype.push=function(e){if(this.bufferSize>0){var t,r,i=e.length+this.bufferSize;if(!this.buffer||this.buffer.length<i){var s=new Uint8Array(i);this.bufferSize>0&&s.set(this.buffer.subarray(0,this.bufferSize)),this.buffer=s}this.buffer.set(e,this.bufferSize),this.bufferSize=i,e=this.buffer,t=i}else t=e.length;for(var a=0;a<t&&(r=this._parse(e,a,t))>0;)a+=r;var o=t-a;o>0&&(!this.buffer||this.buffer.length<o?this.buffer=new Uint8Array(e.subarray(a,t)):this.buffer.set(e.subarray(a,t))),this.bufferSize=o},ec.prototype._parse=function(e,t,r){if(t+2>r)return -1;if(255===e[t]||(224&e[t+1])==224){if(t+24>r)return -1;var i=e[t+1]>>3&3,s=e[t+1]>>1&3,a=e[t+2]>>4&15,o=e[t+2]>>2&3,n=!!(2&e[t+2]);if(1!==i&&0!==a&&15!==a&&3!==o){var h=1e3*el[14*(3===i?3-s:3===s?3:4)+a-1],l=eu[3*(3===i?0:2===i?1:2)+o],u=n?1:0,c=3===s?(3===i?12:6)*h/l+u<<2:(3===i?144:72)*h/l+u|0;return t+c>r?-1:(this.onFrame&&this.onFrame(new Uint8Array(e.subarray(t,t+c))),c)}}for(var d=t+2;d<r;){if(255===e[d-1]&&(224&e[d])==224)return this.onNoise&&this.onNoise(new Uint8Array(e.subarray(t,d-1))),d-t-1;d++}return -1},ec.prototype.close=function(){this.bufferSize>0&&this.onNoise&&this.onNoise(new Uint8Array(this.buffer.subarray(0,this.bufferSize))),this.buffer=null,this.bufferSize=0,this.onClose&&this.onClose()};var ef=function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);function i(){this.constructor=e}e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)};(h=(n=m||(m={})).StringUtilities||(n.StringUtilities={})).utf8decode=function(e){for(var t=new Uint8Array(4*e.length),r=0,i=0,s=e.length;i<s;i++){var a=e.charCodeAt(i);if(a<=127){t[r++]=a;continue}if(55296<=a&&a<=56319){var o=e.charCodeAt(i+1);56320<=o&&o<=57343&&(a=((1023&a)<<10)+(1023&o)+65536,++i)}(4292870144&a)!=0?(t[r++]=248|a>>>24&3,t[r++]=128|a>>>18&63,t[r++]=128|a>>>12&63,t[r++]=128|a>>>6&63):(4294901760&a)!=0?(t[r++]=240|a>>>18&7,t[r++]=128|a>>>12&63,t[r++]=128|a>>>6&63):(4294965248&a)!=0?(t[r++]=224|a>>>12&15,t[r++]=128|a>>>6&63):t[r++]=192|a>>>6&31,t[r++]=128|63&a}return t.subarray(0,r)},h.utf8encode=function(e){for(var t=0,r="";t<e.length;){var i=255&e[t++];if(i<=127)r+=String.fromCharCode(i);else{var s=192,a=5;do{if((i&(s>>1|128))===s)break;s=s>>1|128,--a}while(a>=0);if(a<=0)throw Error("Invalid UTF8 character");for(var o=i&(1<<a)-1,n=5;n>=a;--n){var h=e[t++];if((192&h)!=128)throw Error("Invalid UTF8 character sequence");o=o<<6|63&h}o>=65536?r+=String.fromCharCode(o-65536>>10&1023|55296,1023&o|56320):r+=String.fromCharCode(o)}}return r},function(e){function t(e){for(var t=e.length>>1,r=new Uint8Array(t),i=0;i<t;i++)r[i]=parseInt(e.substr(2*i,2),16);return r}var r,i,s,a,o,n,h,l,u=[5500,11025,22050,44100],c=["PCM","ADPCM","MP3","PCM le","Nellymouser16","Nellymouser8","Nellymouser","G.711 A-law","G.711 mu-law",null,"AAC","Speex","MP3 8khz"];(r=o||(o={}))[r.HEADER=0]="HEADER",r[r.RAW=1]="RAW";var d=[null,"JPEG","Sorenson","Screen","VP6","VP6 alpha","Screen2","AVC"];(i=n||(n={}))[i.KEY=1]="KEY",i[i.INNER=2]="INNER",i[i.DISPOSABLE=3]="DISPOSABLE",i[i.GENERATED=4]="GENERATED",i[i.INFO=5]="INFO",(s=h||(h={}))[s.HEADER=0]="HEADER",s[s.NALU=1]="NALU",s[s.END=2]="END",(a=l||(l={}))[a.CAN_GENERATE_HEADER=0]="CAN_GENERATE_HEADER",a[a.NEED_HEADER_DATA=1]="NEED_HEADER_DATA",a[a.MAIN_PACKETS=2]="MAIN_PACKETS";var f=function(){function r(e){var t=this;this.oncodecinfo=function(e){},this.ondata=function(e){throw Error("MP4Mux.ondata is not set")},this.metadata=e,this.trackStates=this.metadata.tracks.map(function(e,r){var i={trackId:r+1,trackInfo:e,cachedDuration:0,samplesProcessed:0,initializationData:[]};return t.metadata.audioTrackId===r&&(t.audioTrackState=i),t.metadata.videoTrackId===r&&(t.videoTrackState=i),i},this),this._checkIfNeedHeaderData(),this.filePos=0,this.cachedPackets=[],this.chunkIndex=0}return r.prototype.pushPacket=function(e,t,r){switch(this.state===l.CAN_GENERATE_HEADER&&this._tryGenerateHeader(),e){case 8:var i=this.audioTrackState,s=function(e){var t,r=0,i=o.RAW,s=e[r],a=s>>4;switch(r++,a){case 10:i=e[r++],t=1024;break;case 2:var n=e[r+1]>>3&3,h=e[r+1]>>1&3;t=1===h?3===n?1152:576:3===h?384:1152}return{codecDescription:c[a],codecId:a,data:e.subarray(r),rate:u[s>>2&3],size:2&s?16:8,channels:1&s?2:1,samples:t,packetType:i}}(t);if(!i||i.trackInfo.codecId!==s.codecId)throw Error("Unexpected audio packet codec: "+s.codecDescription);switch(s.codecId){default:throw Error("Unsupported audio codec: "+s.codecDescription);case 2:break;case 10:if(s.packetType===o.HEADER){i.initializationData.push(s.data);return}}this.cachedPackets.push({packet:s,timestamp:r,trackId:i.trackId});break;case 9:var a=this.videoTrackState,n=function(e){var t=0,r=e[0]>>4,i=15&e[t];t++;var s={frameType:r,codecId:i,codecDescription:d[i]};switch(i){case 7:var a=e[t++];s.packetType=a,s.compositionTime=(e[t]<<24|e[t+1]<<16|e[t+2]<<8)>>8,t+=3;break;case 4:s.packetType=h.NALU,s.horizontalOffset=e[t]>>4&15,s.verticalOffset=15&e[t],s.compositionTime=0,t++}return s.data=e.subarray(t),s}(t);if(!a||a.trackInfo.codecId!==n.codecId)throw Error("Unexpected video packet codec: "+n.codecDescription);switch(n.codecId){default:throw Error("unsupported video codec: "+n.codecDescription);case 4:break;case 7:if(n.packetType===h.HEADER){a.initializationData.push(n.data);return}}this.cachedPackets.push({packet:n,timestamp:r,trackId:a.trackId});break;default:throw Error("unknown packet type: "+e)}this.state===l.NEED_HEADER_DATA&&this._tryGenerateHeader(),this.cachedPackets.length>=50&&this.state===l.MAIN_PACKETS&&this._chunk()},r.prototype.flush=function(){this.cachedPackets.length>0&&this._chunk()},r.prototype._checkIfNeedHeaderData=function(){this.trackStates.some(function(e){return 10===e.trackInfo.codecId||7===e.trackInfo.codecId})?this.state=l.NEED_HEADER_DATA:this.state=l.CAN_GENERATE_HEADER},r.prototype._tryGenerateHeader=function(){if(this.trackStates.every(function(e){switch(e.trackInfo.codecId){case 10:case 7:return e.initializationData.length>0;default:return!0}})){for(var r=["isom"],i=[],s=0;s<this.trackStates.length;s++){var a,o,n=this.trackStates[s],h=n.trackInfo;switch(h.codecId){case 10:var u=n.initializationData[0];a=new e.Iso.AudioSampleEntry("mp4a",1,h.channels,h.samplesize,h.samplerate);var c=new Uint8Array(41+u.length);c.set(t("0000000003808080"),0),c[8]=32+u.length,c.set(t("00020004808080"),9),c[16]=18+u.length,c.set(t("40150000000000FA000000000005808080"),17),c[34]=u.length,c.set(u,35),c.set(t("068080800102"),35+u.length),a.otherBoxes=[new e.Iso.RawTag("esds",c)];var d=u[0]>>3;n.mimeTypeCodec="mp4a.40."+d;break;case 2:a=new e.Iso.AudioSampleEntry(".mp3",1,h.channels,h.samplesize,h.samplerate),n.mimeTypeCodec="mp3";break;case 7:var f=n.initializationData[0];(a=new e.Iso.VideoSampleEntry("avc1",1,h.width,h.height)).otherBoxes=[new e.Iso.RawTag("avcC",f)];var p=f[1]<<16|f[2]<<8|f[3];n.mimeTypeCodec="avc1."+(16777216|p).toString(16).substr(1),r.push("iso2","avc1","mp41");break;case 4:(a=new e.Iso.VideoSampleEntry("VP6F",1,h.width,h.height)).otherBoxes=[new e.Iso.RawTag("glbl",t("00"))],n.mimeTypeCodec="avc1.42001E";break;default:throw Error("not supported track type")}var E=e.Iso.TrackHeaderFlags.TRACK_ENABLED|e.Iso.TrackHeaderFlags.TRACK_IN_MOVIE;n===this.audioTrackState?o=new e.Iso.TrackBox(new e.Iso.TrackHeaderBox(E,n.trackId,-1,0,0,1,s),new e.Iso.MediaBox(new e.Iso.MediaHeaderBox(h.timescale,-1,h.language),new e.Iso.HandlerBox("soun","SoundHandler"),new e.Iso.MediaInformationBox(new e.Iso.SoundMediaHeaderBox,new e.Iso.DataInformationBox(new e.Iso.DataReferenceBox([new e.Iso.DataEntryUrlBox(e.Iso.SELF_CONTAINED_DATA_REFERENCE_FLAG)])),new e.Iso.SampleTableBox(new e.Iso.SampleDescriptionBox([a]),new e.Iso.RawTag("stts",t("0000000000000000")),new e.Iso.RawTag("stsc",t("0000000000000000")),new e.Iso.RawTag("stsz",t("000000000000000000000000")),new e.Iso.RawTag("stco",t("0000000000000000")))))):n===this.videoTrackState&&(o=new e.Iso.TrackBox(new e.Iso.TrackHeaderBox(E,n.trackId,-1,h.width,h.height,0,s),new e.Iso.MediaBox(new e.Iso.MediaHeaderBox(h.timescale,-1,h.language),new e.Iso.HandlerBox("vide","VideoHandler"),new e.Iso.MediaInformationBox(new e.Iso.VideoMediaHeaderBox,new e.Iso.DataInformationBox(new e.Iso.DataReferenceBox([new e.Iso.DataEntryUrlBox(e.Iso.SELF_CONTAINED_DATA_REFERENCE_FLAG)])),new e.Iso.SampleTableBox(new e.Iso.SampleDescriptionBox([a]),new e.Iso.RawTag("stts",t("0000000000000000")),new e.Iso.RawTag("stsc",t("0000000000000000")),new e.Iso.RawTag("stsz",t("000000000000000000000000")),new e.Iso.RawTag("stco",t("0000000000000000"))))))),i.push(o)}var g=new e.Iso.MovieExtendsBox(null,[new e.Iso.TrackExtendsBox(1,1,0,0,0),new e.Iso.TrackExtendsBox(2,1,0,0,0)],null),m=new e.Iso.BoxContainerBox("udat",[new e.Iso.MetaBox(new e.Iso.RawTag("hdlr",t("00000000000000006D6469726170706C000000000000000000")),[new e.Iso.RawTag("ilst",t("00000025A9746F6F0000001D6461746100000001000000004C61766635342E36332E313034"))])]),_=new e.Iso.MovieHeaderBox(1e3,0,this.trackStates.length+1),S=new e.Iso.MovieBox(_,i,g,m),y=new e.Iso.FileTypeBox("isom",512,r),v=y.layout(0),T=S.layout(v),b=new Uint8Array(v+T);y.write(b),S.write(b),this.oncodecinfo(this.trackStates.map(function(e){return e.mimeTypeCodec})),this.ondata(b),this.filePos+=b.length,this.state=l.MAIN_PACKETS}},r.prototype._chunk=function(){var t=this.cachedPackets;if(this.videoTrackState){for(var r=t.length-1,i=this.videoTrackState.trackId;r>0&&(t[r].trackId!==i||t[r].packet.frameType!==n.KEY);)r--;r>0&&(t=t.slice(0,r))}if(0!==t.length){for(var s=[],a=0,o=[],h=[],l=0;l<this.trackStates.length;l++){var u,c,d,f=this.trackStates[l],p=f.trackInfo,E=f.trackId,g=t.filter(function(e){return e.trackId===E});if(0!==g.length){var m=new e.Iso.TrackFragmentBaseMediaDecodeTimeBox(f.cachedDuration);switch(h.push(a),p.codecId){case 10:case 2:d=[];for(var r=0;r<g.length;r++){var _=g[r].packet,S=Math.round(_.samples*p.timescale/p.samplerate);s.push(_.data),a+=_.data.length,d.push({duration:S,size:_.data.length}),f.samplesProcessed+=_.samples}var y=e.Iso.TrackFragmentFlags.DEFAULT_SAMPLE_FLAGS_PRESENT;u=new e.Iso.TrackFragmentHeaderBox(y,E,0,0,0,0,e.Iso.SampleFlags.SAMPLE_DEPENDS_ON_NO_OTHERS);var v=e.Iso.TrackRunFlags.DATA_OFFSET_PRESENT|e.Iso.TrackRunFlags.SAMPLE_DURATION_PRESENT|e.Iso.TrackRunFlags.SAMPLE_SIZE_PRESENT;c=new e.Iso.TrackRunBox(v,d,0,0),f.cachedDuration=Math.round(f.samplesProcessed*p.timescale/p.samplerate);break;case 7:case 4:d=[];for(var T=f.samplesProcessed,b=Math.round(T*p.timescale/p.framerate),r=0;r<g.length;r++){var R=g[r].packet,P=Math.round(++T*p.timescale/p.framerate),A=P-b;b=P;var I=Math.round(T*p.timescale/p.framerate+R.compositionTime*p.timescale/1e3);s.push(R.data),a+=R.data.length;var w=R.frameType===n.KEY?e.Iso.SampleFlags.SAMPLE_DEPENDS_ON_NO_OTHERS:e.Iso.SampleFlags.SAMPLE_DEPENDS_ON_OTHER|e.Iso.SampleFlags.SAMPLE_IS_NOT_SYNC;d.push({duration:A,size:R.data.length,flags:w,compositionTimeOffset:I-P})}var y=e.Iso.TrackFragmentFlags.DEFAULT_SAMPLE_FLAGS_PRESENT;u=new e.Iso.TrackFragmentHeaderBox(y,E,0,0,0,0,e.Iso.SampleFlags.SAMPLE_DEPENDS_ON_NO_OTHERS);var v=e.Iso.TrackRunFlags.DATA_OFFSET_PRESENT|e.Iso.TrackRunFlags.SAMPLE_DURATION_PRESENT|e.Iso.TrackRunFlags.SAMPLE_SIZE_PRESENT|e.Iso.TrackRunFlags.SAMPLE_FLAGS_PRESENT|e.Iso.TrackRunFlags.SAMPLE_COMPOSITION_TIME_OFFSET;c=new e.Iso.TrackRunBox(v,d,0,0),f.cachedDuration=b,f.samplesProcessed=T;break;default:throw Error("Un codec")}var D=new e.Iso.TrackFragmentBox(u,m,c);o.push(D)}}this.cachedPackets.splice(0,t.length);for(var N=new e.Iso.MovieFragmentHeaderBox(++this.chunkIndex),x=new e.Iso.MovieFragmentBox(N,o),M=x.layout(0),k=new e.Iso.MediaDataBox(s),F=k.layout(M),C=M+8,l=0;l<o.length;l++)o[l].run.dataOffset=C+h[l];var O=new Uint8Array(M+F);x.write(O),k.write(O),this.ondata(O),this.filePos+=O.length}},r}();e.MP4Mux=f,e.parseFLVMetadata=function(e){var t,r,i,s,a=[],o=-1,n=-1,h=+e.asGetPublicProperty("duration"),l=e.asGetPublicProperty("audiocodecid");switch(l){case 2:case"mp3":t="mp3",r=2;break;case 10:case"mp4a":t="mp4a",r=10;break;default:if(!isNaN(l))throw Error("Unsupported audio codec: "+l);t=null,r=-1}var u=e.asGetPublicProperty("videocodecid");switch(u){case 4:case"vp6f":i="vp6f",s=4;break;case 7:case"avc1":i="avc1",s=7;break;default:if(!isNaN(u))throw Error("Unsupported video codec: "+u);i=null,s=-1}var c=null===t?null:{codecDescription:t,codecId:r,language:"und",timescale:+e.asGetPublicProperty("audiosamplerate")||44100,samplerate:+e.asGetPublicProperty("audiosamplerate")||44100,channels:+e.asGetPublicProperty("audiochannels")||2,samplesize:16},d=null===i?null:{codecDescription:i,codecId:s,language:"und",timescale:6e4,framerate:+e.asGetPublicProperty("videoframerate")||+e.asGetPublicProperty("framerate"),width:+e.asGetPublicProperty("width"),height:+e.asGetPublicProperty("height")},f=e.asGetPublicProperty("trackinfo");if(f)for(var p=0;p<f.length;p++){var E=f[p],g=E.asGetPublicProperty("sampledescription")[0];g.asGetPublicProperty("sampletype")===l?(c.language=E.asGetPublicProperty("language"),c.timescale=+E.asGetPublicProperty("timescale")):g.asGetPublicProperty("sampletype")===u&&(d.language=E.asGetPublicProperty("language"),d.timescale=+E.asGetPublicProperty("timescale"))}return d&&(n=a.length,a.push(d)),c&&(o=a.length,a.push(c)),{tracks:a,duration:h,audioTrackId:o,videoTrackId:n}},e.splitMetadata=function(e){var t=[];return e.audioTrackId>=0&&t.push({tracks:[e.tracks[e.audioTrackId]],duration:e.duration,audioTrackId:0,videoTrackId:-1}),e.videoTrackId>=0&&t.push({tracks:[e.tracks[e.videoTrackId]],duration:e.duration,audioTrackId:-1,videoTrackId:0}),t}}((l=g||(g={})).MP4||(l.MP4={})),function(e){var t,r,i,s,a,o,n=m.StringUtilities.utf8decode,h=[1,0,0,0,1,0,0,0,1],l=[0,0,0];function u(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return Array.prototype.concat.apply(e,t)}function c(e,t,r){e[t]=r>>24&255,e[t+1]=r>>16&255,e[t+2]=r>>8&255,e[t+3]=255&r}function d(e){return e.charCodeAt(0)<<24|e.charCodeAt(1)<<16|e.charCodeAt(2)<<8|e.charCodeAt(3)}function f(e){return(e- -20828448e5)/1e3|0}function p(e){return 65536*e|0}function E(e){return 1073741824*e|0}var g=function(){function e(e,t){this.boxtype=e,"uuid"===e&&(this.userType=t)}return e.prototype.layout=function(e){this.offset=e;var t=8;return this.userType&&(t+=16),this.size=t,t},e.prototype.write=function(e){return(c(e,this.offset,this.size),c(e,this.offset+4,d(this.boxtype)),this.userType)?(e.set(this.userType,this.offset+8),24):8},e.prototype.toUint8Array=function(){var e=new Uint8Array(this.layout(0));return this.write(e),e},e}();e.Box=g;var _=function(e){function t(t,r,i){void 0===r&&(r=0),void 0===i&&(i=0);var s=e.call(this,t)||this;return s.version=r,s.flags=i,s}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+4,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,this.version<<24|this.flags),r+4},t}(g);e.FullBox=_;var S=function(e){function t(t,r,i){var s=e.call(this,"ftype")||this;return s.majorBrand=t,s.minorVersion=r,s.compatibleBrands=i,s}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+4*(2+this.compatibleBrands.length),this.size},t.prototype.write=function(t){var r=this,i=e.prototype.write.call(this,t);return c(t,this.offset+i,d(this.majorBrand)),c(t,this.offset+i+4,this.minorVersion),i+=8,this.compatibleBrands.forEach(function(e){c(t,r.offset+i,d(e)),i+=4},this),i},t}(g);e.FileTypeBox=S;var y=function(e){function t(t,r){var i=e.call(this,t)||this;return i.children=r,i}return ef(t,e),t.prototype.layout=function(t){var r=e.prototype.layout.call(this,t);return this.children.forEach(function(e){e&&(r+=e.layout(t+r))}),this.size=r},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return this.children.forEach(function(e){e&&(r+=e.write(t))}),r},t}(g);e.BoxContainerBox=y;var v=function(e){function t(t,r,i,s){var a=e.call(this,"moov",u([t],r,[i,s]))||this;return a.header=t,a.tracks=r,a.extendsBox=i,a.userData=s,a}return ef(t,e),t}(y);e.MovieBox=v;var T=function(e){function t(t,r,i,s,a,o,n,l){void 0===s&&(s=1),void 0===a&&(a=1),void 0===o&&(o=h),void 0===n&&(n=-20828448e5),void 0===l&&(l=-20828448e5);var u=e.call(this,"mvhd",0,0)||this;return u.timescale=t,u.duration=r,u.nextTrackId=i,u.rate=s,u.volume=a,u.matrix=o,u.creationTime=n,u.modificationTime=l,u}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+16+4+2+2+8+36+24+4,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,f(this.creationTime)),c(t,this.offset+r+4,f(this.modificationTime)),c(t,this.offset+r+8,this.timescale),c(t,this.offset+r+12,this.duration),r+=16,c(t,this.offset+r,p(this.rate)),c(t,this.offset+r+4,(256*this.volume|0)<<16),c(t,this.offset+r+8,0),c(t,this.offset+r+12,0),r+=16,c(t,this.offset+r,p(this.matrix[0])),c(t,this.offset+r+4,p(this.matrix[1])),c(t,this.offset+r+8,p(this.matrix[2])),c(t,this.offset+r+12,p(this.matrix[3])),c(t,this.offset+r+16,p(this.matrix[4])),c(t,this.offset+r+20,p(this.matrix[5])),c(t,this.offset+r+24,E(this.matrix[6])),c(t,this.offset+r+28,E(this.matrix[7])),c(t,this.offset+r+32,E(this.matrix[8])),r+=36,c(t,this.offset+r,0),c(t,this.offset+r+4,0),c(t,this.offset+r+8,0),c(t,this.offset+r+12,0),c(t,this.offset+r+16,0),c(t,this.offset+r+20,0),r+=24,c(t,this.offset+r,this.nextTrackId),r+=4},t}(_);e.MovieHeaderBox=T,(t=e.TrackHeaderFlags||(e.TrackHeaderFlags={}))[t.TRACK_ENABLED=1]="TRACK_ENABLED",t[t.TRACK_IN_MOVIE=2]="TRACK_IN_MOVIE",t[t.TRACK_IN_PREVIEW=4]="TRACK_IN_PREVIEW";var b=function(e){function t(t,r,i,s,a,o,n,l,u,c,d){void 0===n&&(n=0),void 0===l&&(l=0),void 0===u&&(u=h),void 0===c&&(c=-20828448e5),void 0===d&&(d=-20828448e5);var f=e.call(this,"tkhd",0,t)||this;return f.trackId=r,f.duration=i,f.width=s,f.height=a,f.volume=o,f.alternateGroup=n,f.layer=l,f.matrix=u,f.creationTime=c,f.modificationTime=d,f}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+20+8+6+2+36+8,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,f(this.creationTime)),c(t,this.offset+r+4,f(this.modificationTime)),c(t,this.offset+r+8,this.trackId),c(t,this.offset+r+12,0),c(t,this.offset+r+16,this.duration),r+=20,c(t,this.offset+r,0),c(t,this.offset+r+4,0),c(t,this.offset+r+8,this.layer<<16|this.alternateGroup),c(t,this.offset+r+12,(256*this.volume|0)<<16),r+=16,c(t,this.offset+r,p(this.matrix[0])),c(t,this.offset+r+4,p(this.matrix[1])),c(t,this.offset+r+8,p(this.matrix[2])),c(t,this.offset+r+12,p(this.matrix[3])),c(t,this.offset+r+16,p(this.matrix[4])),c(t,this.offset+r+20,p(this.matrix[5])),c(t,this.offset+r+24,E(this.matrix[6])),c(t,this.offset+r+28,E(this.matrix[7])),c(t,this.offset+r+32,E(this.matrix[8])),r+=36,c(t,this.offset+r,p(this.width)),c(t,this.offset+r+4,p(this.height)),r+=8},t}(_);e.TrackHeaderBox=b;var R=function(e){function t(t,r,i,s,a){void 0===i&&(i="unk"),void 0===s&&(s=-20828448e5),void 0===a&&(a=-20828448e5);var o=e.call(this,"mdhd",0,0)||this;return o.timescale=t,o.duration=r,o.language=i,o.creationTime=s,o.modificationTime=a,o}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+16+4,this.size},t.prototype.write=function(t){var r,i=e.prototype.write.call(this,t);return c(t,this.offset+i,f(this.creationTime)),c(t,this.offset+i+4,f(this.modificationTime)),c(t,this.offset+i+8,this.timescale),c(t,this.offset+i+12,this.duration),c(t,this.offset+i+16,((31&(r=this.language).charCodeAt(0))<<10|(31&r.charCodeAt(1))<<5|31&r.charCodeAt(2))<<16),i+20},t}(_);e.MediaHeaderBox=R;var P=function(e){function t(t,r){var i=e.call(this,"hdlr",0,0)||this;return i.handlerType=t,i.name=r,i._encodedName=n(i.name),i}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+8+12+(this._encodedName.length+1),this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,0),c(t,this.offset+r+4,d(this.handlerType)),c(t,this.offset+r+8,0),c(t,this.offset+r+12,0),c(t,this.offset+r+16,0),r+=20,t.set(this._encodedName,this.offset+r),t[this.offset+r+this._encodedName.length]=0,r+=this._encodedName.length+1},t}(_);e.HandlerBox=P;var A=function(e){function t(t){void 0===t&&(t=0);var r=e.call(this,"smhd",0,0)||this;return r.balance=t,r}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+4,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,(256*this.balance|0)<<16),r+4},t}(_);e.SoundMediaHeaderBox=A;var I=function(e){function t(t,r){void 0===t&&(t=0),void 0===r&&(r=l);var i=e.call(this,"vmhd",0,0)||this;return i.graphicsMode=t,i.opColor=r,i}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+8,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,this.graphicsMode<<16|this.opColor[0]),c(t,this.offset+r+4,this.opColor[1]<<16|this.opColor[2]),r+8},t}(_);e.VideoMediaHeaderBox=I,e.SELF_CONTAINED_DATA_REFERENCE_FLAG=1;var w=function(t){function r(r,i){void 0===i&&(i=null);var s=t.call(this,"url ",0,r)||this;return s.location=i,r&e.SELF_CONTAINED_DATA_REFERENCE_FLAG||(s._encodedLocation=n(i)),s}return ef(r,t),r.prototype.layout=function(e){var r=t.prototype.layout.call(this,e);return this._encodedLocation&&(r+=this._encodedLocation.length+1),this.size=r},r.prototype.write=function(e){var r=t.prototype.write.call(this,e);return this._encodedLocation&&(e.set(this._encodedLocation,this.offset+r),e[this.offset+r+this._encodedLocation.length]=0,r+=this._encodedLocation.length),r},r}(_);e.DataEntryUrlBox=w;var D=function(e){function t(t){var r=e.call(this,"dref",0,0)||this;return r.entries=t,r}return ef(t,e),t.prototype.layout=function(t){var r=e.prototype.layout.call(this,t)+4;return this.entries.forEach(function(e){r+=e.layout(t+r)}),this.size=r},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,this.entries.length),this.entries.forEach(function(e){r+=e.write(t)}),r},t}(_);e.DataReferenceBox=D;var N=function(e){function t(t){var r=e.call(this,"dinf",[t])||this;return r.dataReference=t,r}return ef(t,e),t}(y);e.DataInformationBox=N;var x=function(e){function t(t){var r=e.call(this,"stsd",0,0)||this;return r.entries=t,r}return ef(t,e),t.prototype.layout=function(t){var r=e.prototype.layout.call(this,t);return r+=4,this.entries.forEach(function(e){r+=e.layout(t+r)}),this.size=r},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,this.entries.length),r+=4,this.entries.forEach(function(e){r+=e.write(t)}),r},t}(_);e.SampleDescriptionBox=x;var M=function(e){function t(t,r,i,s,a){var o=e.call(this,"stbl",[t,r,i,s,a])||this;return o.sampleDescriptions=t,o.timeToSample=r,o.sampleToChunk=i,o.sampleSizes=s,o.chunkOffset=a,o}return ef(t,e),t}(y);e.SampleTableBox=M;var k=function(e){function t(t,r,i){var s=e.call(this,"minf",[t,r,i])||this;return s.header=t,s.info=r,s.sampleTable=i,s}return ef(t,e),t}(y);e.MediaInformationBox=k;var F=function(e){function t(t,r,i){var s=e.call(this,"mdia",[t,r,i])||this;return s.header=t,s.handler=r,s.info=i,s}return ef(t,e),t}(y);e.MediaBox=F;var C=function(e){function t(t,r){var i=e.call(this,"trak",[t,r])||this;return i.header=t,i.media=r,i}return ef(t,e),t}(y);e.TrackBox=C;var O=function(e){function t(t,r,i,s,a){var o=e.call(this,"trex",0,0)||this;return o.trackId=t,o.defaultSampleDescriptionIndex=r,o.defaultSampleDuration=i,o.defaultSampleSize=s,o.defaultSampleFlags=a,o}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+20,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,this.trackId),c(t,this.offset+r+4,this.defaultSampleDescriptionIndex),c(t,this.offset+r+8,this.defaultSampleDuration),c(t,this.offset+r+12,this.defaultSampleSize),c(t,this.offset+r+16,this.defaultSampleFlags),r+20},t}(_);e.TrackExtendsBox=O;var L=function(e){function t(t,r,i){var s=e.call(this,"mvex",u([t],r,[i]))||this;return s.header=t,s.tracDefaults=r,s.levels=i,s}return ef(t,e),t}(y);e.MovieExtendsBox=L;var U=function(e){function t(t,r){var i=e.call(this,"meta",0,0)||this;return i.handler=t,i.otherBoxes=r,i}return ef(t,e),t.prototype.layout=function(t){var r=e.prototype.layout.call(this,t);return r+=this.handler.layout(t+r),this.otherBoxes.forEach(function(e){r+=e.layout(t+r)}),this.size=r},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return r+=this.handler.write(t),this.otherBoxes.forEach(function(e){r+=e.write(t)}),r},t}(_);e.MetaBox=U;var B=function(e){function t(t){var r=e.call(this,"mfhd",0,0)||this;return r.sequenceNumber=t,r}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+4,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,this.sequenceNumber),r+4},t}(_);e.MovieFragmentHeaderBox=B,(r=a=e.TrackFragmentFlags||(e.TrackFragmentFlags={}))[r.BASE_DATA_OFFSET_PRESENT=1]="BASE_DATA_OFFSET_PRESENT",r[r.SAMPLE_DESCRIPTION_INDEX_PRESENT=2]="SAMPLE_DESCRIPTION_INDEX_PRESENT",r[r.DEFAULT_SAMPLE_DURATION_PRESENT=8]="DEFAULT_SAMPLE_DURATION_PRESENT",r[r.DEFAULT_SAMPLE_SIZE_PRESENT=16]="DEFAULT_SAMPLE_SIZE_PRESENT",r[r.DEFAULT_SAMPLE_FLAGS_PRESENT=32]="DEFAULT_SAMPLE_FLAGS_PRESENT";var z=function(e){function t(t,r,i,s,a,o,n){var h=e.call(this,"tfhd",0,t)||this;return h.trackId=r,h.baseDataOffset=i,h.sampleDescriptionIndex=s,h.defaultSampleDuration=a,h.defaultSampleSize=o,h.defaultSampleFlags=n,h}return ef(t,e),t.prototype.layout=function(t){var r=e.prototype.layout.call(this,t)+4,i=this.flags;return i&a.BASE_DATA_OFFSET_PRESENT&&(r+=8),i&a.SAMPLE_DESCRIPTION_INDEX_PRESENT&&(r+=4),i&a.DEFAULT_SAMPLE_DURATION_PRESENT&&(r+=4),i&a.DEFAULT_SAMPLE_SIZE_PRESENT&&(r+=4),i&a.DEFAULT_SAMPLE_FLAGS_PRESENT&&(r+=4),this.size=r},t.prototype.write=function(t){var r=e.prototype.write.call(this,t),i=this.flags;return c(t,this.offset+r,this.trackId),r+=4,i&a.BASE_DATA_OFFSET_PRESENT&&(c(t,this.offset+r,0),c(t,this.offset+r+4,this.baseDataOffset),r+=8),i&a.SAMPLE_DESCRIPTION_INDEX_PRESENT&&(c(t,this.offset+r,this.sampleDescriptionIndex),r+=4),i&a.DEFAULT_SAMPLE_DURATION_PRESENT&&(c(t,this.offset+r,this.defaultSampleDuration),r+=4),i&a.DEFAULT_SAMPLE_SIZE_PRESENT&&(c(t,this.offset+r,this.defaultSampleSize),r+=4),i&a.DEFAULT_SAMPLE_FLAGS_PRESENT&&(c(t,this.offset+r,this.defaultSampleFlags),r+=4),r},t}(_);e.TrackFragmentHeaderBox=z;var G=function(e){function t(t){var r=e.call(this,"tfdt",0,0)||this;return r.baseMediaDecodeTime=t,r}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+4,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,this.baseMediaDecodeTime),r+4},t}(_);e.TrackFragmentBaseMediaDecodeTimeBox=G;var H=function(e){function t(t,r,i){var s=e.call(this,"traf",[t,r,i])||this;return s.header=t,s.decodeTime=r,s.run=i,s}return ef(t,e),t}(y);e.TrackFragmentBox=H,(i=e.SampleFlags||(e.SampleFlags={}))[i.IS_LEADING_MASK=201326592]="IS_LEADING_MASK",i[i.SAMPLE_DEPENDS_ON_MASK=50331648]="SAMPLE_DEPENDS_ON_MASK",i[i.SAMPLE_DEPENDS_ON_OTHER=16777216]="SAMPLE_DEPENDS_ON_OTHER",i[i.SAMPLE_DEPENDS_ON_NO_OTHERS=33554432]="SAMPLE_DEPENDS_ON_NO_OTHERS",i[i.SAMPLE_IS_DEPENDED_ON_MASK=12582912]="SAMPLE_IS_DEPENDED_ON_MASK",i[i.SAMPLE_HAS_REDUNDANCY_MASK=3145728]="SAMPLE_HAS_REDUNDANCY_MASK",i[i.SAMPLE_PADDING_VALUE_MASK=917504]="SAMPLE_PADDING_VALUE_MASK",i[i.SAMPLE_IS_NOT_SYNC=65536]="SAMPLE_IS_NOT_SYNC",i[i.SAMPLE_DEGRADATION_PRIORITY_MASK=65535]="SAMPLE_DEGRADATION_PRIORITY_MASK",(s=o=e.TrackRunFlags||(e.TrackRunFlags={}))[s.DATA_OFFSET_PRESENT=1]="DATA_OFFSET_PRESENT",s[s.FIRST_SAMPLE_FLAGS_PRESENT=4]="FIRST_SAMPLE_FLAGS_PRESENT",s[s.SAMPLE_DURATION_PRESENT=256]="SAMPLE_DURATION_PRESENT",s[s.SAMPLE_SIZE_PRESENT=512]="SAMPLE_SIZE_PRESENT",s[s.SAMPLE_FLAGS_PRESENT=1024]="SAMPLE_FLAGS_PRESENT",s[s.SAMPLE_COMPOSITION_TIME_OFFSET=2048]="SAMPLE_COMPOSITION_TIME_OFFSET";var q=function(e){function t(t,r,i,s){var a=e.call(this,"trun",1,t)||this;return a.samples=r,a.dataOffset=i,a.firstSampleFlags=s,a}return ef(t,e),t.prototype.layout=function(t){var r=e.prototype.layout.call(this,t)+4,i=this.samples.length,s=this.flags;return s&o.DATA_OFFSET_PRESENT&&(r+=4),s&o.FIRST_SAMPLE_FLAGS_PRESENT&&(r+=4),s&o.SAMPLE_DURATION_PRESENT&&(r+=4*i),s&o.SAMPLE_SIZE_PRESENT&&(r+=4*i),s&o.SAMPLE_FLAGS_PRESENT&&(r+=4*i),s&o.SAMPLE_COMPOSITION_TIME_OFFSET&&(r+=4*i),this.size=r},t.prototype.write=function(t){var r=e.prototype.write.call(this,t),i=this.samples.length,s=this.flags;c(t,this.offset+r,i),r+=4,s&o.DATA_OFFSET_PRESENT&&(c(t,this.offset+r,this.dataOffset),r+=4),s&o.FIRST_SAMPLE_FLAGS_PRESENT&&(c(t,this.offset+r,this.firstSampleFlags),r+=4);for(var a=0;a<i;a++){var n=this.samples[a];s&o.SAMPLE_DURATION_PRESENT&&(c(t,this.offset+r,n.duration),r+=4),s&o.SAMPLE_SIZE_PRESENT&&(c(t,this.offset+r,n.size),r+=4),s&o.SAMPLE_FLAGS_PRESENT&&(c(t,this.offset+r,n.flags),r+=4),s&o.SAMPLE_COMPOSITION_TIME_OFFSET&&(c(t,this.offset+r,n.compositionTimeOffset),r+=4)}return r},t}(_);e.TrackRunBox=q;var V=function(e){function t(t,r){var i=e.call(this,"moof",u([t],r))||this;return i.header=t,i.trafs=r,i}return ef(t,e),t}(y);e.MovieFragmentBox=V;var K=function(e){function t(t){var r=e.call(this,"mdat")||this;return r.chunks=t,r}return ef(t,e),t.prototype.layout=function(t){var r=e.prototype.layout.call(this,t);return this.chunks.forEach(function(e){r+=e.length}),this.size=r},t.prototype.write=function(t){var r=this,i=e.prototype.write.call(this,t);return this.chunks.forEach(function(e){t.set(e,r.offset+i),i+=e.length},this),i},t}(g);e.MediaDataBox=K;var J=function(e){function t(t,r){var i=e.call(this,t)||this;return i.dataReferenceIndex=r,i}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+8,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,0),c(t,this.offset+r+4,this.dataReferenceIndex),r+8},t}(g);e.SampleEntry=J;var j=function(e){function t(t,r,i,s,a,o){void 0===i&&(i=2),void 0===s&&(s=16),void 0===a&&(a=44100),void 0===o&&(o=null);var n=e.call(this,t,r)||this;return n.channelCount=i,n.sampleSize=s,n.sampleRate=a,n.otherBoxes=o,n}return ef(t,e),t.prototype.layout=function(t){var r=e.prototype.layout.call(this,t)+20;return this.otherBoxes&&this.otherBoxes.forEach(function(e){r+=e.layout(t+r)}),this.size=r},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return c(t,this.offset+r,0),c(t,this.offset+r+4,0),c(t,this.offset+r+8,this.channelCount<<16|this.sampleSize),c(t,this.offset+r+12,0),c(t,this.offset+r+16,this.sampleRate<<16),r+=20,this.otherBoxes&&this.otherBoxes.forEach(function(e){r+=e.write(t)}),r},t}(J);e.AudioSampleEntry=j,e.COLOR_NO_ALPHA_VIDEO_SAMPLE_DEPTH=24;var Q=function(t){function r(r,i,s,a,o,n,h,l,u,c){void 0===o&&(o=""),void 0===n&&(n=72),void 0===h&&(h=72),void 0===l&&(l=1),void 0===u&&(u=e.COLOR_NO_ALPHA_VIDEO_SAMPLE_DEPTH),void 0===c&&(c=null);var d=t.call(this,r,i)||this;if(d.width=s,d.height=a,d.compressorName=o,d.horizResolution=n,d.vertResolution=h,d.frameCount=l,d.depth=u,d.otherBoxes=c,o.length>31)throw Error("invalid compressor name");return d}return ef(r,t),r.prototype.layout=function(e){var r=t.prototype.layout.call(this,e)+16+12+4+2+32+2+2;return this.otherBoxes&&this.otherBoxes.forEach(function(t){r+=t.layout(e+r)}),this.size=r},r.prototype.write=function(e){var r=t.prototype.write.call(this,e);c(e,this.offset+r,0),c(e,this.offset+r+4,0),c(e,this.offset+r+8,0),c(e,this.offset+r+12,0),r+=16,c(e,this.offset+r,this.width<<16|this.height),c(e,this.offset+r+4,p(this.horizResolution)),c(e,this.offset+r+8,p(this.vertResolution)),r+=12,c(e,this.offset+r,0),c(e,this.offset+r+4,this.frameCount<<16),r+=6,e[this.offset+r]=this.compressorName.length;for(var i=0;i<31;i++)e[this.offset+r+i+1]=i<this.compressorName.length?127&this.compressorName.charCodeAt(i):0;return r+=32,c(e,this.offset+r,this.depth<<16|65535),r+=4,this.otherBoxes&&this.otherBoxes.forEach(function(t){r+=t.write(e)}),r},r}(J);e.VideoSampleEntry=Q;var W=function(e){function t(t,r){var i=e.call(this,t)||this;return i.data=r,i}return ef(t,e),t.prototype.layout=function(t){return this.size=e.prototype.layout.call(this,t)+this.data.length,this.size},t.prototype.write=function(t){var r=e.prototype.write.call(this,t);return t.set(this.data,this.offset+r),r+this.data.length},t}(g);e.RawTag=W}((c=(u=g||(g={})).MP4||(u.MP4={})).Iso||(c.Iso={}));var ep=g.MP4.MP4Mux;let eE={rate:44100,id:3},eg=eE.rate,em={getInputFormat:()=>({mimeType:"audio/mpeg"}),getOutputFormat:()=>({mimeType:"audio/mp4",audioCodec:{id:"mp3"}}),transmux:e=>new R.helpers.abortableJob.AbortableJob(()=>{let t=R.helpers.deferred.buildDeferred(),r=new R.eventDispatcher.EventDispatcher,i=[],s=!1,a=null,o=!1,n=new ec,h=new ep({audioTrackId:0,videoTrackId:-1,tracks:[{codecId:2,channels:2,samplerate:eE.rate,samplesize:16,timescale:eg}]});function l(){n.close(),h.flush()}function u(r){o=!0;try{l()}catch(e){}t.reject(r),e.abort()}return h.ondata=e=>{o||(a?(i.push(e),r.dispatch({initData:a,data:e})):a=e)},n.onNoise=e=>{!o&&(ed(e)||u(new x))},n.onFrame=e=>{if(!o)try{let t;let r=new Uint8Array(e.length+1);t=32|eE.id<<2|3,r[0]=t,r.set(e,1),h.pushPacket(8,r,0)}catch(e){u(e)}},e.onProgressUpdate(e=>{let t=e.data;!s&&e.initData&&(t=R.helpers.arrayBuffer.combine([e.initData,e.data])),s=!0;try{n.push(t)}catch(e){u(e)}}),e.onCompletion(e=>{try{l(),t.resolve(e)}catch(e){u(e)}}),e.onError(u),{result:t.promise,progressUpdates:{onProgressUpdate:r,getProgressSoFar:()=>i.length?{initData:a,data:R.helpers.arrayBuffer.combine(i)}:null},abort:()=>{o=!0,e.abort(),l()}}}).run()};var e_=T(3);let eS=[{getInputFormat:()=>({mimeType:"audio/mpeg"}),getOutputFormat:()=>({mimeType:"audio/mpeg"}),transmux:e=>new R.helpers.abortableJob.AbortableJob(()=>{let t=R.helpers.deferred.buildDeferred(),r=new R.eventDispatcher.EventDispatcher,i=[],s=[],a=!1,o=!1,n=new ec;function h(){n.close()}function l(r){o=!0;try{h()}catch(e){}t.reject(r),e.abort()}return n.onNoise=e=>{!o&&(ed(e)||l(new x))},n.onFrame=e=>{if(!o)try{s.push(e)}catch(e){l(e)}},e.onProgressUpdate(e=>{let t=e.data;!a&&e.initData&&(t=R.helpers.arrayBuffer.combine([e.initData,e.data])),a=!0;try{if(n.push(t),s.length){let e=R.helpers.arrayBuffer.combine(s);i.push(e),s.splice(0),r.dispatch({data:e})}}catch(e){l(e)}}),e.onCompletion(e=>{try{h(),t.resolve(e)}catch(e){l(e)}}),e.onError(l),{result:t.promise,progressUpdates:{onProgressUpdate:r,getProgressSoFar:()=>i.length?{data:R.helpers.arrayBuffer.combine(i)}:null},abort:()=>{o=!0,e.abort(),h()}}}).run()},{getInputFormat:()=>({mimeType:"audio/mp4"}),getOutputFormat:()=>({mimeType:"audio/mp4"}),transmux:e=>new R.helpers.abortableJob.AbortableJob(()=>{let t=R.helpers.deferred.buildDeferred(),r=new R.eventDispatcher.EventDispatcher,i=[],s=[],a=new Uint8Array(0),o=null,n=!1,h=e=>{if(e.byteLength<4){a=e;return}if(null===o){let t=new DataView(e.buffer).getUint32(0);if(1===t)throw Error("Large atom size not supported.");o=t}if(0!==o&&e.byteLength>=o){let t=new Uint8Array(e.buffer.slice(0,o));s.push(t),a=new Uint8Array(e.buffer.slice(o)),o=null,h(a)}else a=e};function l(r){t.reject(r),e.abort()}return e.onProgressUpdate(e=>{let t=e.data;!n&&e.initData&&(t=R.helpers.arrayBuffer.combine([e.initData,e.data])),n=!0;try{let e=R.helpers.arrayBuffer.combine([a,t]);if(h(e),s.length){let e=R.helpers.arrayBuffer.combine(s);s.splice(0),i.push(e),r.dispatch({data:e})}}catch(e){l(e)}}),e.onCompletion(e=>{try{if(0===o)i.push(a),r.dispatch({data:a});else if(a.byteLength)throw Error("Part way through an atom.");t.resolve(e)}catch(e){l(e)}}),e.onError(l),{result:t.promise,progressUpdates:{onProgressUpdate:r,getProgressSoFar:()=>i.length?{data:R.helpers.arrayBuffer.combine(i)}:null},abort:()=>{e.abort()}}}).run()},eh,em,{getInputFormat:()=>({mimeType:"audio/ogg",audioCodec:{id:"opus"}}),getOutputFormat:()=>({mimeType:"audio/webm",audioCodec:{id:"opus"}}),transmux:e=>new R.helpers.abortableJob.AbortableJob(()=>{let t=R.helpers.deferred.buildDeferred(),r=new R.eventDispatcher.EventDispatcher,i=[],s=null,a=new Uint8Array(0),o=!1,n=null,h=!1;function l(r){h=!0,t.reject(r),e.abort()}return e.onProgressUpdate(e=>{if(h)return;let t=[a,e.data];!o&&e.initData&&(t=[e.initData,...t]),o=!0;let u=R.helpers.arrayBuffer.combine(t);try{let{pages:e}=(0,P.retrievePages)(u),t=e.reduce((e,t)=>e+t.entirePage.byteLength,0);a=new Uint8Array(u.buffer.slice(t));let o=(0,P.retrievePackets)(e);if(o.length&&!s){if(o.length<2)throw Error("Expecting at least 2 opus packets.");(0,e_.parseOpusHead)(o[0]).outputGain>-2&&(0,e_.setOutputGain)(o[0],-2),s=[o[0],o[1]],o=o.slice(2)}if(o.length&&s){i.push(...o);let e=(0,e_.buildWebm)([...s,...o]);n||(n=e.initData),r.dispatch({initData:n,data:e.data})}}catch(e){l(e)}}),e.onCompletion(e=>{a.byteLength?t.reject(Error("Still data left in buffer.")):t.resolve(e)}),e.onError(l),{result:t.promise,progressUpdates:{onProgressUpdate:r,getProgressSoFar:()=>{if(i.length&&s){let e=(0,e_.buildWebm)([...s,...i]).data;return{initData:n,data:e}}return null}},abort:()=>{h=!0,e.abort()}}}).run()}],ey={retrieveTransmuxers:(e,t)=>eS.filter(r=>{let i=r.getInputFormat(),s=r.getOutputFormat();return(!e||w(i,e))&&(!t||w(s,t))}),retrieveTransmuxer:(e,t)=>ey.retrieveTransmuxers(e,t)[0]||null};class ev extends A{constructor(e){super(),this._details=e}getDetails(){return this._details}getCode(){return"PLAYLIST_PARSE"}}class eT extends A{getCode(){return"UNSUPPORTED_ENCRYPTION_ERROR"}}(d=_||(_={})).NoDecryptorError=er,d.PlaylistParseError=ev,d.OggParserError=I,d.Mp3TransmuxerRetrievalError=D,d.RetrievalError=A,d.UnacceptableResponseStatusCodeError=Q,d.UnsupportedEncryptionError=eT;class eb{constructor(e,t){this._playlist=e,this._url=t}getPlaylist(){return this._playlist}getUrl(){return this._url}}class eR{constructor(e,t){this._playlist=e,this._url=t}getPlaylist(){return this._playlist}getUrl(){return this._url}}class eP{constructor(e){this._url=e}getUrl(){return this._url}}(f=S||(S={})).InitData=eb,f.Key=eR,f.Playlist=eP,f.Segment=z;let eA="31.1.0",eI=2227;return b})(),e.exports=i(r(18471),r(61308),r(42012))}}]);